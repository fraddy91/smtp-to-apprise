<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <title>SMTP ‚Üí Apprise Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://unpkg.com/@picocss/pico@latest/css/pico.slate.min.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    .copy-btn { font-size: 0.8em; margin-left: 0.5em; cursor: pointer; }
    #searchBox { margin-bottom: 1em; }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }

    #moon-icon path {
      fill: black;
    }
    #sun-icon path {
      fill: white;
    }
    #themeToggle {
      padding: 0.4em 0.6em;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.5em;
      line-height: 1;
      padding: 0;
      outline: none;
    }
    #themeToggle:focus {
      outline: none;
      box-shadow: none;
    }
    #themeToggle svg {
      width: 26px;
      height: 26px;
    }
    #themeToggle:hover svg {
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    /* Light theme */
    html[data-theme="light"] td[contenteditable="true"] {
      background-color: #f9f9f9;
      color: #222;
    }
    html[data-theme="light"] td[contenteditable="true"]:hover {
      outline: 1px dashed #aaa;
      background-color: #fff;
    }
    html[data-theme="light"] td[contenteditable="true"]:focus {
      outline: 2px solid #0078d7;
      background-color: #eef6ff;
    }

    /* Dark theme */
    html[data-theme="dark"] td[contenteditable="true"] {
      background-color: #1e1e1e;
      color: #ddd;
    }
    html[data-theme="dark"] td[contenteditable="true"]:hover {
      outline: 1px dashed #666;
      background-color: #2a2a2a;
    }
    html[data-theme="dark"] td[contenteditable="true"]:focus {
      outline: 2px solid #4da3ff;
      background-color: #252f3f;
    }
    /* Sorting */
    th.sorted-asc::after {
      content: " ‚ñ≤";
      font-size: 0.8em;
    }
    th.sorted-desc::after {
      content: " ‚ñº";
      font-size: 0.8em;
    }
    /* Toast notifications */
    td.saved {
      background-color: #1e3d1e !important; /* dark green */
      transition: background-color 1s ease;
    }
    td.error {
      background-color: #3d1e1e !important; /* dark red */
      transition: background-color 1s ease;
    }
    .toast {
      background: #333;
      color: #fff;
      padding: 0.5em 1em;
      margin-top: 0.5em;
      border-radius: 4px;
      opacity: 0.9;
      animation: fadein 0.3s, fadeout 0.3s 2.7s;
    }
    @keyframes fadein { from {opacity:0;} to {opacity:0.9;} }
    @keyframes fadeout { from {opacity:0.9;} to {opacity:0;} }
    .toast.success { background: #28a745; }
    .toast.error { background: #dc3545; }
  </style>
</head>
<body>
  <main class="container">
    <div class="header-bar">
      <h1>üì¨ SMTP ‚Üí Apprise Config</h1>
      <!-- <button id="themeToggle" aria-label="Toggle theme">üåì</button> -->
      <button id="themeToggle">
        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.56 122.88"><defs><style>.cls-1{fill-rule:evenodd;}</style></defs><path class="cls-1" d="M121.85,87.3A64.31,64.31,0,1,1,36.88.4c2.94-1.37,5.92.91,4.47,4.47a56.29,56.29,0,0,0,75.75,77.4l.49-.27a3.41,3.41,0,0,1,4.61,4.61l-.35.69ZM92.46,74.67H92A16.11,16.11,0,0,0,76.2,58.93v-.52a15.08,15.08,0,0,0,11-4.72,15.19,15.19,0,0,0,4.72-11h.51a15.12,15.12,0,0,0,4.72,11,15.12,15.12,0,0,0,11,4.72v.51A16.13,16.13,0,0,0,92.46,74.67Zm10.09-46.59h-.27a7.94,7.94,0,0,0-2.49-5.81A7.94,7.94,0,0,0,94,19.78v-.27A7.94,7.94,0,0,0,99.79,17a8,8,0,0,0,2.49-5.8h.27A8,8,0,0,0,105,17a8,8,0,0,0,5.81,2.49v.27A8,8,0,0,0,105,22.27a7.94,7.94,0,0,0-2.49,5.81Zm-41.5,8h-.41a12.06,12.06,0,0,0-3.78-8.82A12.06,12.06,0,0,0,48,23.5v-.41a12.07,12.07,0,0,0,8.82-3.78,12.09,12.09,0,0,0,3.78-8.82h.41a12.08,12.08,0,0,0,3.77,8.82,12.09,12.09,0,0,0,8.83,3.78v.41a12.09,12.09,0,0,0-8.83,3.78,12.08,12.08,0,0,0-3.77,8.82Z"/></svg>
        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 122.88"><title>sun-warm</title><path d="M30,13.21A3.93,3.93,0,1,1,36.8,9.27L41.86,18A3.94,3.94,0,1,1,35.05,22L30,13.21Zm31.45,13A35.23,35.23,0,1,1,36.52,36.52,35.13,35.13,0,0,1,61.44,26.2ZM58.31,4A3.95,3.95,0,1,1,66.2,4V14.06a3.95,3.95,0,1,1-7.89,0V4ZM87.49,10.1A3.93,3.93,0,1,1,94.3,14l-5.06,8.76a3.93,3.93,0,1,1-6.81-3.92l5.06-8.75ZM109.67,30a3.93,3.93,0,1,1,3.94,6.81l-8.75,5.06a3.94,3.94,0,1,1-4-6.81L109.67,30Zm9.26,28.32a3.95,3.95,0,1,1,0,7.89H108.82a3.95,3.95,0,1,1,0-7.89Zm-6.15,29.18a3.93,3.93,0,1,1-3.91,6.81l-8.76-5.06A3.93,3.93,0,1,1,104,82.43l8.75,5.06ZM92.89,109.67a3.93,3.93,0,1,1-6.81,3.94L81,104.86a3.94,3.94,0,0,1,6.81-4l5.06,8.76Zm-28.32,9.26a3.95,3.95,0,1,1-7.89,0V108.82a3.95,3.95,0,1,1,7.89,0v10.11Zm-29.18-6.15a3.93,3.93,0,0,1-6.81-3.91l5.06-8.76A3.93,3.93,0,1,1,40.45,104l-5.06,8.75ZM13.21,92.89a3.93,3.93,0,1,1-3.94-6.81L18,81A3.94,3.94,0,1,1,22,87.83l-8.76,5.06ZM4,64.57a3.95,3.95,0,1,1,0-7.89H14.06a3.95,3.95,0,1,1,0,7.89ZM10.1,35.39A3.93,3.93,0,1,1,14,28.58l8.76,5.06a3.93,3.93,0,1,1-3.92,6.81L10.1,35.39Z"/></svg>
      </button>
    </div>

    <!-- Toast container for JS notifications -->
    <div id="toast-container" style="position:fixed;top:1em;right:1em;z-index:9999;"></div>

    <!-- Search box -->
    <input type="text" id="searchBox" placeholder="Search records‚Ä¶">

    <!-- Table -->
    <div style="overflow-x:auto;">
      <table role="grid">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Email</th>
            <th onclick="sortTable(1)">Key</th>
            <th onclick="sortTable(2)">Tags</th>
            <th onclick="sortTable(3)">MIME Type</th>
            <th onclick="sortTable(4)">Action</th>
          </tr>
        </thead>
        <tbody>
          {{range .Records}}
          <tr>
            <td>
              {{.Email}}
              <button class="copy-btn" onclick="copy('{{.Email}}')">üìã</button>
            </td>
            <td contenteditable="true" 
                title="Click to edit"
                onblur="updateRecord('{{.Email}}','{{.MimeType}}', this, 'apprise_key')">
              {{.Key}} 
            </td>
            <td contenteditable="true" 
                title="Click to edit"
                onblur="updateRecord('{{.Email}}','{{.MimeType}}', this, 'tags')">
              {{.Tags}}
            </td>
            <td>
              {{.MimeType}}
            </td>
            <td>
              <form method="POST" action="/delete" onsubmit="return handleDelete(this)" style="display:inline">
                <input type="hidden" name="email" value="{{.Email}}">
                <input type="hidden" name="key" value="{{.Key}}">
                <input type="hidden" name="mime_type" value="{{.MimeType}}">
                <button type="submit" class="contrast">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>

    <!-- Form to add records -->
    <h2>Add / Update Record</h2>
    <form method="POST" action="/add" autocomplete="off">
      <label>Email
        <input type="email" name="email" required>
      </label>
      <label>Key
        <input type="text" name="key" required autocomplete="on">
      </label>
      <label>Tags
        <input type="text" name="tags">
      </label>
      <label>MIME Type
        <select name="mime_type" required>
          <option value="text/plain">Plain text</option>
          <option value="text/html">HTML</option>
          <option value="multipart">Whole message (raw MIME)</option>
        </select>
      </label>
      <button type="submit">üíæ Save</button>
    </form>
  </main>

  <script>
    // Theme switching seems to work as html attribute now
    const themeBtn = document.getElementById("themeToggle");
    const html = document.documentElement;
    const moonIcon = document.getElementById("moon-icon");
    const sunIcon = document.getElementById("sun-icon");

    themeBtn.addEventListener("click", () => {
      const isDark = html.getAttribute("data-theme") === "dark";
      html.setAttribute("data-theme", isDark ? "light" : "dark");
      localStorage.setItem("theme", isDark ? "light" : "dark");
      sunIcon.style.display = !isDark ? "inline" : "none";
      moonIcon.style.display = !isDark ? "none" : "inline";
    });

    // On load, set theme icon
      window.addEventListener("DOMContentLoaded", () => {
      const isDark = html.getAttribute("data-theme") === "dark";
      sunIcon.style.display = isDark ? "inline" : "none";
      moonIcon.style.display = isDark ? "none" : "inline";
    });

    // Set system theme or localStorage theme
    if (!localStorage.getItem("theme")) {
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      document.documentElement.setAttribute("data-theme", prefersDark ? "dark" : "light");
    }
    else{
      if (localStorage.getItem("theme") === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
      }
      else{
        document.documentElement.setAttribute("data-theme", "light");
      }
    }

    // Update inline editable cells
    function updateRecord(email, mimeType, cell, field) {
      const newValue = cell.innerText.trim();
      fetch('/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, mime_type: mimeType, field, value: newValue })
      }).then(r => {
        if (r.ok) {  showToast("Record updated", "success");
        } else {
          showToast("Update failed", "error");
        }
      });
    }

    //Keyboard shortcuts
    document.addEventListener("keydown", e => {
      const cell = document.activeElement;
      if (cell && cell.hasAttribute("contenteditable")) {
        if (e.key === "Enter") {
          e.preventDefault();
          cell.blur(); // triggers updateRecord
          const nextRow = cell.parentElement.nextElementSibling;
          if (nextRow) {
            const sameCol = cell.cellIndex;
            const nextCell = nextRow.cells[sameCol];
            if (nextCell && nextCell.hasAttribute("contenteditable")) {
              nextCell.focus();
            }
          }
        }
        if (e.key === "Escape") {
          document.execCommand("undo"); // revert last change
          cell.blur();
        }
      }
    });

    // Sort table
    function sortTable(colIndex) {
      const tbody = document.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const asc = tbody.getAttribute("data-sort-col") != colIndex || tbody.getAttribute("data-sort-dir") === "desc";
      rows.sort((a, b) => {
        const A = a.cells[colIndex].innerText.toLowerCase();
        const B = b.cells[colIndex].innerText.toLowerCase();
        return asc ? A.localeCompare(B) : B.localeCompare(A);
      });
      rows.forEach(r => tbody.appendChild(r));
      // update state
      tbody.setAttribute("data-sort-col", colIndex);
      tbody.setAttribute("data-sort-dir", asc ? "asc" : "desc");
      // clear old indicators
      document.querySelectorAll("th").forEach(th => th.classList.remove("sorted-asc","sorted-desc"));
      document.querySelectorAll("thead th")[colIndex].classList.add(asc ? "sorted-asc" : "sorted-desc");
    }

    // Copy to clipboard
    function copy(text) {
      navigator.clipboard.writeText(text);
    }

    // Search filter
    const box = document.getElementById("searchBox");
    box.addEventListener("input", () => {
      const term = box.value.toLowerCase();
      document.querySelectorAll("tbody tr").forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(term) ? "" : "none";
      });
    });

    // Notification toasts
    function showToast(msg, type="info") {
      const toast = document.createElement("div");
      toast.textContent = msg;
      toast.className = "toast " + type;
      document.getElementById("toast-container").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    //

    // Trigger server‚Äëside messages after DOM + function exist
    window.addEventListener("DOMContentLoaded", () => {
      // Comments to trick linter
      /* {{if .Success }} */ showToast("‚úÖ Record saved!", "success"); /* {{end}} */
      /* {{if .Error}} */ showToast("‚ùå {{.Error}}", "error"); /* {{end}} */
    });

    // Delete
    function handleDelete(form) {
      if (confirm("Are you sure you want to delete this record?")) {
        fetch(form.action, {
          method: "POST",
          body: new FormData(form)
        }).then(r => {
          if (r.ok) {
            showToast("Record deleted", "success");
            form.closest("tr").remove();
          } else {
            showToast("Delete failed", "error");
          }
        });
      }
      return false;
    }
  </script>
</body>
</html>